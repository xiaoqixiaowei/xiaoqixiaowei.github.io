---
layout: article
title: "CAN通信记录"
---

# **CAN**



本文是看的华南虎，中科大RM的CAN相关的视频以及查阅资料，做了一个记录（里面加了一些通信方面的思考！！！😂），后面还会补上软件端的设置

## Background

### 分层思想

CAN信号可以分为三个层次，这个和计网里面的思路是一样的

* 物理信号层

* 链路传输层

* 应用数据层

对于硬件设计部分实际上就考虑物理层就够了

### 差分信号

在通信里面我们也经常用差分信号来增大SNR，其原理是比如一根线收到干扰，它如果单单靠一个判别门限来进行判定，当干扰较大的时候可能会产生误判

差分的思路是用两根线来进行传输，而这两根线基本上是绑在一起的，外部的干扰对两根线可以看作是同等程度的影响，当做差的时候，就相当于消除了这种干扰

### 显隐性

码元1被编码成CAN_H和CAN_L电平相同，称为隐性电平，均为2.5V，

显性为CAN_H为3.5V，CAN_L为1.5V

这里注意一下，`码元1`其实叫`隐性电平`，`码元0`叫做是`显性电平`

隐性的意思就是说H和L的电平是一样的

## Basic structure

可以看到橘色框内就是STM32的内部，我们的MCU是自带CAN控制器的，但是他发出来的电平是？？？（这个后续会补上测量的结果），然后接上CAN收发器就可以向CAN总线上发送东西了，我们平时焊接的就是CAN收发芯片

<img src="https://xiaoqixiaowei.oss-cn-chengdu.aliyuncs.com/img_for_typora/image-20230324221647519.png" alt="image-20230324221647519" style="zoom:50%;" />

另外一点我们需要注意CAN的终端电阻的接入方法，我们不是采用星型连接，而是首尾加入120Ω（这个值也是经验值），这样我们拿万用表进行测量的时候，实际上是60欧姆，终端电阻的主要作用概括起来就是让信号尽快进入隐性（即1），另外一个是吸收发过来的信号，防止回波造成的干扰。但实际上在我们测试的时候，短距离终端电阻有多个也没有什么大的影响，但是在长距离传播的时候可能会有问题。

<img src="https://xiaoqixiaowei.oss-cn-chengdu.aliyuncs.com/img_for_typora/image-20230324211429919.png" alt="image-20230324211429919" style="zoom: 33%;" />

### 收发模式介绍

<img src="https://xiaoqixiaowei.oss-cn-chengdu.aliyuncs.com/img_for_typora/image-20230324212657163.png" alt="image-20230324212657163" style="zoom:50%;" />

一般都是常规模式

### 发送规则

#### CAN ID

<img src="https://xiaoqixiaowei.oss-cn-chengdu.aliyuncs.com/img_for_typora/image-20230324212916810.png" alt="image-20230324212916810" style="zoom: 33%;" />

就类似IP号

### 协议细节

#### 物理层的仲裁

假如我在发高电平，另外一个人在发低电平

冲突检测和冲突避免的时候，CAN使用的是冲突检测

如果有1和0，显性的就直接掩盖隐性，就是0



#### 链路层的误码校验

CRC算法



#### 滤波器

利用CAN ID以及Mask来过滤

eg. CAN ID为0x114要配置两个东西，一个是CAN ID(过滤目标)0x114 ，还有一个是掩码0x7ff，掩码就为1的部分都要匹配，为0的部分不用管

左侧就是0x114，右侧是接收0x114~0x117

![image-20230324213724696](https://xiaoqixiaowei.oss-cn-chengdu.aliyuncs.com/img_for_typora/image-20230324213724696.png)

这个掩码和计网里面的子网掩码差不多



#### 帧结构

帧有很多，但是我们并不是都要关注，只需要关注数据帧，遥控帧



##### 遥控帧 

​	就是请求命令

##### 错误帧

​	出错了会自行生成和接收

##### 过载帧

​	发送一个表示告诉别人我现在busy，设计的好，别人就会降低发送速率

##### 数据帧

​	对于标准和扩展数据帧，`CANid`的长度不一样

![image-20230324215019189](https://xiaoqixiaowei.oss-cn-chengdu.aliyuncs.com/img_for_typora/image-20230324215019189.png)

**起始段：**

* `起始段是显性电平0`

​			如果不通信就是2.5V，隐形电平1，只有出现**显性电平0**的时候，**才是标志起始**

**仲裁段：**

* ID `显性设备继续发，隐形设备就闭嘴，ID越小表示优先级越高`

​		比如一个ID是201，一个是202，ID大的表示1就靠前，所以201就会有优先权

* RTR 远程发送请求，发送了就要别人给数据，标准数据帧里面是显性电平0，如果是拓展帧就是隐性电平1

**控制段：**

* IDR
* 保留位
* DLC 是数据长度的字节，CAN协议中数据长度是0~8字节，但如果接收方接收到DLC为9以上也不会认为错

**数据段：**

​	Data，长度为（0~8）byte= （0~8）*8bits

**校验段：**

**回复段：**

​	ACK

**结束段：**

​	结束标志符



**拓展帧**

![image-20230324215730231](https://xiaoqixiaowei.oss-cn-chengdu.aliyuncs.com/img_for_typora/image-20230324215730231.png)





